name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Desktop Extension
      run: |
        # Remove any existing DXT file
        rm -f *.dxt
        
        # Create the DXT package
        zip -r home-assistant-mcp.dxt \
          manifest.json \
          server/ \
          node_modules/ \
          package.json \
          package-lock.json \
          icon.svg

    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## What's Changed
          
          ### Desktop Extension
          - Download `home-assistant-mcp.dxt` and double-click to install in Claude Desktop
          
          ### Docker Container
          - Available at `ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}`
          - Also tagged as `ghcr.io/${{ github.repository }}:latest`
          
          ### Usage
          
          **Desktop Extension:**
          ```bash
          # Download and double-click the .dxt file
          ```
          
          **Docker:**
          ```bash
          docker run -p 3000:3000 \
            -e HA_URL="https://homeassistant.local:8123" \
            -e HA_TOKEN="your-token" \
            -e TRANSPORT=http \
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
          ```
          
          **Docker Compose:**
          ```yaml
          services:
            home-assistant-mcp:
              image: ghcr.io/${{ github.repository }}:${{ steps.version.outputs.VERSION }}
              ports:
                - "3000:3000"
              environment:
                - HA_URL=https://homeassistant.local:8123
                - HA_TOKEN=your-token
                - TRANSPORT=http
          ```
        files: |
          home-assistant-mcp.dxt
        draft: false
        prerelease: false 