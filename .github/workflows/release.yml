name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          # First release
          CHANGELOG="ðŸŽ‰ Initial release of Home Assistant History MCP Server

        ## Features
        - ðŸ  Connect to Home Assistant via REST API
        - ðŸ“Š Retrieve historical data for entities
        - ðŸ“ˆ Access long-term statistics with configurable periods
        - ðŸ” Entity discovery and search capabilities  
        - ðŸ“‹ Logbook integration for events
        - ðŸ³ Secure Docker deployment
        - â° Flexible time range support
        - âœ… Comprehensive input validation

        ## Quick Start
        \`\`\`bash
        # One command setup with your credentials
        docker run -d \\
          --name ha-history-mcp \\
          -e HA_URL=\"https://your-homeassistant.com\" \\
          -e HA_TOKEN=\"your-token\" \\
          --restart unless-stopped \\
          ghcr.io/jtenniswood/ha-history-mcp:${{ steps.get_version.outputs.tag_name }}
        \`\`\`

        Or download docker-compose.yml and edit your credentials:
        \`\`\`bash
        curl -O https://github.com/jtenniswood/ha-history-mcp/releases/download/${{ steps.get_version.outputs.tag_name }}/docker-compose.yml
        # Edit HA_URL and HA_TOKEN in the file
        docker-compose up -d
        \`\`\`"
        else
          # Generate changelog from commits
          CHANGELOG="## What's Changed"
          CHANGELOG="$CHANGELOG"$'\n'"$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --reverse)"
        fi
        
        # Save changelog to file and output
        echo "$CHANGELOG" > CHANGELOG.md
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        release_name: Release ${{ steps.get_version.outputs.tag_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.tag_name, '-') }}

    - name: Upload public docker-compose.yml
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./docker-compose.public.yml
        asset_name: docker-compose.yml
        asset_content_type: text/plain

    - name: Create quick-start guide
      run: |
        cat > QUICK-START.md << 'EOF'
        # Quick Start Guide

        ## One-Command Setup

        Replace `YOUR_URL` and `YOUR_TOKEN` with your Home Assistant details:

        ```bash
        docker run -d \
          --name ha-history-mcp \
          -e HA_URL="YOUR_URL" \
          -e HA_TOKEN="YOUR_TOKEN" \
          --restart unless-stopped \
          ghcr.io/jtenniswood/ha-history-mcp:${{ steps.get_version.outputs.tag_name }}
        ```

        ## Docker Compose Setup

        1. Download the docker-compose.yml:
        ```bash
        curl -O https://github.com/jtenniswood/ha-history-mcp/releases/download/${{ steps.get_version.outputs.tag_name }}/docker-compose.yml
        ```

        2. Edit the file and replace:
        - `HA_URL=https://your-homeassistant.com` â†’ Your HA URL
        - `HA_TOKEN=your-long-lived-access-token` â†’ Your HA token

        3. Start the service:
        ```bash
        docker-compose up -d
        ```

        ## Configure Claude Desktop

        Add to `~/Library/Application Support/Claude/claude_desktop_config.json`:

        ```json
        {
          "mcpServers": {
            "ha-history": {
              "command": "docker",
              "args": [
                "exec", "-i", "ha-history-mcp-server", 
                "python", "src/ha_history_mcp_server.py"
              ]
            }
          }
        }
        ```

        ## Test

        Ask Claude: "Show me the temperature history for the last 24 hours"

        For full documentation, see: https://github.com/jtenniswood/ha-history-mcp
        EOF

    - name: Upload quick-start guide
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./QUICK-START.md
        asset_name: QUICK-START.md
        asset_content_type: text/plain