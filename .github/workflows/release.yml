name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          # First release
          CHANGELOG="🎉 Initial release of Home Assistant History MCP Server

        ## Features
        - 🏠 Connect to Home Assistant via REST API
        - 📊 Retrieve historical data for entities
        - 📈 Access long-term statistics with configurable periods
        - 🔍 Entity discovery and search capabilities  
        - 📋 Logbook integration for events
        - 🐳 Secure Docker deployment
        - ⏰ Flexible time range support
        - ✅ Simple configuration with direct credentials

        ## Quick Setup
        
        Add to Claude Desktop config:
        
        \`\`\`json
        {
          \"mcpServers\": {
            \"ha-history\": {
              \"command\": \"docker\",
              \"args\": [
                \"run\", \"--rm\", \"-i\",
                \"-e\", \"HA_URL=https://your-homeassistant.com\",
                \"-e\", \"HA_TOKEN=your-token\",
                \"ghcr.io/jtenniswood/ha-history-mcp:$TAG_NAME\"
              ]
            }
          }
        }
        \`\`\`
        
        Replace with your actual Home Assistant URL and token, then restart Claude Desktop!"
        else
          # Generate changelog from commits
          CHANGELOG="## What's Changed"
          CHANGELOG="$CHANGELOG"$'\n'"$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --reverse)"
        fi
        
        # Save changelog to output
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        release_name: Release ${{ steps.get_version.outputs.tag_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.tag_name, '-') }}

    - name: Create setup guide
      run: |
        cat > SETUP-GUIDE.md << 'EOF'
        # Home Assistant MCP Server Setup

        ## Quick Setup

        1. **Get your Home Assistant token:**
           - Go to Home Assistant → Profile → Security
           - Create a "Long-lived access token"
           - Copy the token

        2. **Add to Claude Desktop config:**

           **File**: `~/Library/Application Support/Claude/claude_desktop_config.json` (macOS)
           **File**: `%APPDATA%/Claude/claude_desktop_config.json` (Windows)

           ```json
           {
             "mcpServers": {
               "ha-history": {
                 "command": "docker",
                 "args": [
                   "run", "--rm", "-i",
                   "-e", "HA_URL=https://your-homeassistant.com",
                   "-e", "HA_TOKEN=your-long-lived-access-token",
                   "ghcr.io/jtenniswood/ha-history-mcp:${{ steps.get_version.outputs.tag_name }}"
                 ]
               }
             }
           }
           ```

           **Replace with your actual values:**
           - `https://your-homeassistant.com` → Your Home Assistant URL
           - `your-long-lived-access-token` → Your Home Assistant token

        3. **Restart Claude Desktop**

        4. **Test it:**
           Ask Claude: "What entities are available in my Home Assistant?"

        ## Example Queries

        - "Show me the temperature history for the last 24 hours"
        - "What sensors are available in my Home Assistant?"
        - "Get daily temperature statistics for the past month"
        - "What events happened in the last hour?"

        For more information: https://github.com/jtenniswood/ha-history-mcp
        EOF

    - name: Upload setup guide
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./SETUP-GUIDE.md
        asset_name: SETUP-GUIDE.md
        asset_content_type: text/plain